<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Ford Smart Scanner</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    /* --- CRITICAL LAYOUT FIXES --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root { --ford-blue: #003478; --bg-gray: #f4f5f8; --success: #2e7d32; }
    
    body {
        font-family: "Ford Antenna", -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
        background: var(--bg-gray);
        display: flex; flex-direction: column; align-items: center;
        padding: 20px; margin: 0; min-height: 100vh;
    }

    .scanner-widget {
        background: white; width: 100%; max-width: 360px;
        border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden; display: flex; flex-direction: column;
    }

    .widget-header {
        background: var(--ford-blue); color: white; padding: 15px;
        font-weight: 700; text-transform: uppercase; text-align: center; letter-spacing: 0.5px;
    }

    .widget-body { padding: 20px; min-height: 280px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

    /* BUTTON STYLES */
    .btn-scan {
        background: var(--ford-blue); color: white; border: none;
        padding: 16px; border-radius: 8px; font-weight: 700;
        cursor: pointer; margin-top: 20px; width: 100%;
        font-size: 16px;
    }

    .btn-action {
        background: var(--success); color: white; border: none;
        padding: 16px; width: 100%; border-radius: 8px; font-weight: 700;
        cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        text-decoration: none; font-size: 16px; margin-top: 15px;
    }
    
    /* Result Card Styles */
    .asset-card {
        width: 100%; /* Ensures it fits container */
        border: 1px solid #ddd; border-left: 5px solid var(--success);
        background: #f9fff9; padding: 15px; border-radius: 4px;
        text-align: left;
    }

    #state-camera { display: none; width: 100%; flex-direction: column; }
    #reader { width: 100%; height: 250px; background: black; border-radius: 8px; margin-bottom: 15px; }
    #state-result { display: none; width: 100%; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body>

<div class="scanner-widget">
    <div class="widget-header">Equipment Lookup</div>

    <div class="widget-body">
        
        <div id="state-idle" style="text-align:center; width:100%;">
            <svg style="width:50px;height:50px;fill:#999;margin-bottom:15px;" viewBox="0 0 24 24"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></svg>
            <p style="color:#555; font-size:14px; margin:0;">Scan equipment tag to retrieve safety manuals.</p>
            <button class="btn-scan" onclick="startScanner()">Start Scanner</button>
        </div>

        <div id="state-camera">
            <div id="reader"></div>
            <button onclick="reset()" style="background:#eee; border:none; padding:12px; width:100%; border-radius:8px; font-weight:600; color:#333;">Cancel</button>
        </div>

        <div id="state-result">
            <div class="asset-card">
                <div style="background:#c8e6c9; color:#2e7d32; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:700; text-transform:uppercase; display:inline-block; margin-bottom:8px;">âœ“ Manual Found</div>
                <div style="font-size:18px; font-weight:800; color:#1a1a1a; margin-bottom:5px;" id="res-name">Loading...</div>
                <div style="font-size:13px; color:#666; margin-bottom:5px;" id="res-id">ID: ...</div>
            </div>

            <button id="res-link-btn" class="btn-action" onclick="forceOpenLink()">
                <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                Open Manual
            </button>
            
            <div style="margin-top:20px; text-align:center;">
                <span style="font-size:14px; color:#003478; text-decoration:underline; cursor:pointer;" onclick="startScanner()">Scan Next Item</span>
            </div>
        </div>

    </div>
</div>

<script>
    let html5QrCode;
    let currentUrl = "";

    // MOCK DATABASE
    const assetDatabase = {
        "FORD-A": { name: "Hydraulic Press #4", url: "https://www.google.com" },
        "default": { name: "Generic Asset 001", url: "https://www.google.com" }
    };

    function startScanner() {
        document.getElementById('state-idle').style.display = 'none';
        document.getElementById('state-result').style.display = 'none';
        document.getElementById('state-camera').style.display = 'flex';

        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 200, height: 200 } }, onScanSuccess);
    }

    function onScanSuccess(decodedText) {
        html5QrCode.stop().then(() => {
            const asset = assetDatabase[decodedText] || assetDatabase["default"];
            
            // Set Data
            document.getElementById('res-name').innerText = asset.name;
            document.getElementById('res-id').innerText = "Asset ID: " + decodedText;
            
            // SAVE THE URL FOR THE BUTTON
            currentUrl = asset.url;

            // Show Result
            document.getElementById('state-camera').style.display = 'none';
            document.getElementById('state-result').style.display = 'block';
        });
    }

    // --- FORCE OPEN LOGIC ---
    function forceOpenLink() {
        if(!currentUrl) return;
        
        // Method 1: Standard Window Open (Try First)
        var win = window.open(currentUrl, '_blank');
        
        // Method 2: If popup blocked, try redirecting current window
        if (!win || win.closed || typeof win.closed == 'undefined') {
            window.location.href = currentUrl;
        }
    }

    function reset() {
        if(html5QrCode) html5QrCode.stop();
        document.getElementById('state-camera').style.display = 'none';
        document.getElementById('state-result').style.display = 'none';
        document.getElementById('state-idle').style.display = 'block';
    }
</script>

</body>
</html>
